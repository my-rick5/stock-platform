version: '3.8'

networks:
  macro_network:
    driver: bridge

services:
  # 1. KAFKA (KRaft Mode - No ZooKeeper needed)
  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: kafka
    networks:
      - macro_network
    ports:
      - "9092:9092"
    environment:
      KAFKA_NODE_ID: 1
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
      KAFKA_JMX_PORT: 9101
      KAFKA_PROCESS_ROLES: 'broker,controller'
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_CONTROLLER_QUORUM_VOTERS: '1@kafka:29093'
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:29092,CONTROLLER://0.0.0.0:29093,PLAINTEXT_HOST://0.0.0.0:9092
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      CLUSTER_ID: 'MkU3OEVBNTcwNTJENDM2Qk' # Standard local ID

  # 2. QUESTDB (High-Speed Time-Series)
  questdb:
    image: questdb/questdb:latest
    container_name: questdb
    networks:
      - macro_network
    ports:
      - "9000:9000" # Web Console
      - "9009:9009" # InfluxDB Line Protocol (ILP)
      - "8812:8812" # Postgres Wire Protocol
    volumes:
      - ./questdb_data:/var/lib/questdb

  # 3. POSTGRES (Metadata & MLflow Backend)
  db:
    image: postgres:14
    container_name: mlflow_db
    networks:
      - macro_network
    environment:
      - POSTGRES_USER=mlflow
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=mlflow
    volumes:
      - ./postgres_data:/var/lib/postgresql/data

  # 4. MINIO (S3-compatible Artifact Store)
  minio:
    image: minio/minio:latest
    container_name: minio
    networks:
      - macro_network
    ports:
      - "9001:9001" # Console
    environment:
      MINIO_ROOT_USER: admin
      MINIO_ROOT_PASSWORD: password
    command: server /data --console-address ":9001"

  # 5. MLFLOW (Model Registry)
  mlflow:
    image: ghcr.io/mlflow/mlflow:latest
    container_name: mlflow
    networks:
      - macro_network
    ports:
      - "5000:5000"
    depends_on:
      - db
      - minio
    environment:
      - AWS_ACCESS_KEY_ID=admin
      - AWS_SECRET_ACCESS_KEY=password
      - MLFLOW_S3_ENDPOINT_URL=http://minio:9000
    command: >
      mlflow server 
      --backend-store-uri postgresql://mlflow:password@db:5432/mlflow 
      --artifacts-destination s3://mlflow-artifacts 
      --serve-artifacts 
      --host 0.0.0.0
